{% extends 'layout/base.html' %}
{% block title %}Editar Ficha Cl√≠nica{% endblock %}

{% block content %}
    
    {% if ficha.pk %}
        <h2>üìù Editar Ficha Cl√≠nica #{{ ficha.pk }}</h2>
        <p class="text-muted">Paciente: {{ ficha.ingreso.paciente.nombres }} {{ ficha.ingreso.paciente.apellidos }} (RUT: {{ ficha.ingreso.paciente.rut }})</p>
    {% else %}
        <h2>üìù Nueva Ficha Cl√≠nica</h2>
    {% endif %}

    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            Actualizaci√≥n de Datos Cl√≠nicos y Resumen
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                {# Muestra los campos del formulario #}
                {{ form.as_p }}
                
                <button type="submit" class="btn btn-success">
                    Guardar Cambios
                </button>
                
                <a href="{% url 'ficha_list' %}" class="btn btn-secondary">
                    Cancelar
                </a>
            </form>
        </div>
    </div>

    {% if ficha.pk %}
        <hr>
        <h3>Notas M√©dicas Asociadas</h3>
        <p>
            <a href="{% url 'nota_create' ficha_id=ficha.pk %}" class="btn btn-sm btn-success">
                + A√±adir Nueva Nota
            </a>
        </p>
        
        {% if ficha.notas.all %}
            {% for nota in ficha.notas.all|dictsort:"-fecha_hora" %}
                <div class="card mb-2">
                    <div class="card-header small text-muted">
                        **{{ nota.medico }}** | {{ nota.fecha_hora|date:"d M Y H:i" }}
                    </div>
                    <div class="card-body py-2">
                        {{ nota.detalle|linebreaksbr }}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="alert alert-warning mt-3">No hay notas registradas para esta ficha.</p>
        {% endif %}
    {% endif %}

{% endblock %}
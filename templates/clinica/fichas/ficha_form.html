{% extends 'layout/base.html' %}
{% block title %}Ficha Clínica{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-6">
      <div class="card shadow mb-4">
        <div class="card-header py-3 bg-info text-white">
          <h6 class="m-0 font-weight-bold">Datos Clínicos del Paciente: {{ clinical_form.instance.nombres }}
          </h6>
        </div>
        <div class="card-body">
          <form method="post" id="clinicalForm">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="{{ clinical_form.peso.id_for_label }}">Peso (kg)</label>
                {{ clinical_form.peso }}
                <div class="text-danger small error-message" data-field="peso"></div>
                {{ clinical_form.peso.errors }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ clinical_form.estatura.id_for_label }}">Estatura (m)</label>
                {{ clinical_form.estatura }}
                <div class="text-danger small error-message" data-field="estatura"></div>
                {{ clinical_form.estatura.errors }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="{{ clinical_form.grupo_sanguineo.id_for_label }}">Grupo Sanguíneo</label>
                {{ clinical_form.grupo_sanguineo }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="{{ clinical_form.fecha_nacimiento.id_for_label }}">Fecha Nacimiento</label>
                {{ clinical_form.fecha_nacimiento }}
              </div>
            </div>

            <hr>
            <h6 class="font-weight-bold text-primary">Gestión de Alergias</h6>

            <div class="row mb-3">
              <div class="col-md-5">
                <label>Categoría</label>

              </div>

              <div class="col-md-2 d-flex align-items-end">
                <button type="button" id="btnAgregarAlergia" class="btn btn-success btn-block">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>

            <div id="listaAlergias" class="mb-3">
              {% if clinical_form.instance.alergias.exists %}
              {% for alergia in clinical_form.instance.alergias.all %}
              <span class="badge bg-warning text-dark me-1 mb-1" id="badge-alergia-{{ alergia.id }}">
                {{ alergia.ale_nombre }}
                <i class="fas fa-times ms-1 text-danger cursor-pointer btn-eliminar-alergia"
                  data-paciente-id="{{ clinical_form.instance.id }}" data-alergia-id="{{ alergia.id }}"
                  style="cursor: pointer;"></i>
              </span>
              {% endfor %}
              {% else %}
              <span id="no-alergias-msg" class="text-muted small">Sin alergias registradas.</span>
              {% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ clinical_form.alergias_libre.id_for_label }}">Otras Alergias (Texto Libre)</label>
              {{ clinical_form.alergias_libre }}
            </div>

            <hr>
            <div class="mb-3">
              <label for="{{ clinical_form.detalles_alta.id_for_label }}">Detalles de Alta (Antecedentes
                previos)</label>
              {{ clinical_form.detalles_alta }}
            </div>

            <h6 class="font-weight-bold text-primary mt-4">Datos de la Ficha</h6>
            {{ form.as_p }}

            <button type="submit" id="submitBtn" class="btn btn-primary btn-block mt-3">
              <i class="fas fa-save"></i> Guardar Ficha y Datos Clínicos
            </button>
            <a href="{% url 'ficha_list' %}" class="btn btn-secondary btn-block">Cancelar</a>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow mb-4">
        <div class="card-header py-3 bg-secondary text-white d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold">Resumen del Paciente</h6>
          {% if object %}
          <a href="{% url 'ficha_pdf' object.pk %}" class="btn btn-sm btn-light text-dark" target="_blank">
            <i class="fas fa-file-pdf"></i> Exportar PDF
          </a>
          {% endif %}
        </div>
        <div class="card-body">
          <p><strong>RUT:</strong> {{ clinical_form.instance.rut }}</p>
          <p><strong>Edad:</strong> {{ clinical_form.instance.edad }} años</p>
          <p><strong>Sexo:</strong> {{ clinical_form.instance.get_sexo_display }}</p>
          <p><strong>Teléfono:</strong> {{ clinical_form.instance.telefono }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {

    const pesoInput = document.getElementById("{{ clinical_form.peso.id_for_label }}");
    const estaturaInput = document.getElementById("{{ clinical_form.estatura.id_for_label }}");
    const clinicalForm = document.getElementById("clinicalForm");

    // --- Lógica de Manejo de Input Común ---
    function cleanNumericInput(value) {
      // 1. Reemplazar coma por punto y eliminar caracteres no numéricos
      let v = value.replace(/,/g, ".").replace(/[^0-9.]/g, "");

      // 2. Asegurar que no haya múltiples puntos, manteniendo solo el primero
      const parts = v.split(".");
      if (parts.length > 2) {
        // Reconstruir la cadena tomando la parte entera y el primer segmento decimal
        v = parts[0] + "." + parts.slice(1).join("");
      }
      return v;
    }

    // ----------------------------------------------------
    // HANDLER ESPECÍFICO: PESO (3 ENTEROS + 1 DECIMAL) - VERSIÓN FINAL
    // Permite 123 -> 12.3 y 1234 -> 123.4 (desplazamiento).
    // Si ya hay un punto (22.3), permite añadir un dígito para desplazarlo (223.4).
    // ----------------------------------------------------
    function handlePesoInput() {
      let v = cleanNumericInput(pesoInput.value);

      // Si el valor ya contiene un punto, lo separamos.
      const parts = v.split(".");
      let newValue;

      if (parts.length > 1) {
        // CASO A: HAY PUNTO (Ingreso manual o resultado del desplazamiento anterior)

        let soloNumeros = parts[0] + parts[1];

        // Limitar a 4 dígitos totales para la restricción 999.9
        if (soloNumeros.length > 4) {
          soloNumeros = soloNumeros.substring(soloNumeros.length - 4);
        }

        const len = soloNumeros.length;

        // Reaplicamos la lógica de desplazamiento a la cadena limpia de 4 dígitos
        if (len >= 3) {
          const indicePunto = len - 1;
          newValue = soloNumeros.substring(0, indicePunto) + "." + soloNumeros.substring(indicePunto, indicePunto + 1);
        } else {
          // Si el usuario borra dígitos hasta tener 1 o 2, lo mantenemos sin punto (ej: '22')
          newValue = soloNumeros;
        }

      } else {
        // CASO B: NO HAY PUNTO (Entrada de solo números)
        let soloNumeros = parts[0];

        // Limitar a 4 dígitos totales
        if (soloNumeros.length > 4) {
          soloNumeros = soloNumeros.substring(soloNumeros.length - 4);
        }

        const len = soloNumeros.length;

        // Desplazamiento automático del punto: Se activa cuando la longitud es >= 3
        if (len >= 3) {
          const indicePunto = len - 1;
          newValue = soloNumeros.substring(0, indicePunto) + "." + soloNumeros.substring(indicePunto);
        } else {
          newValue = soloNumeros;
        }
      }

      // 4. Validación del máximo (999.9)
      const numValue = parseFloat(newValue);

      // Bloquear si excede 999.9
      if (!isNaN(numValue) && numValue > 999.9) {
        return;
      }

      // Si el valor es válido ( <= 999.9), actualizamos el input.
      pesoInput.value = newValue;
    }

    // ----------------------------------------------------
    // HANDLER ESPECÍFICO: ESTATURA (1 ENTERO + 2 DECIMALES)
    // Scenarios: 1 -> 1, 7 -> 1.7, 5 -> 1.75
    // ----------------------------------------------------
    function handleEstaturaInput() {
      let v = cleanNumericInput(estaturaInput.value);
      const parts = v.split(".");

      if (parts.length === 1) {
        let soloNumeros = parts[0];

        // Limitar la entrada a 3 dígitos para el desplazamiento (max 2.50)
        if (soloNumeros.length > 3) {
          soloNumeros = soloNumeros.substring(soloNumeros.length - 3);
        }

        // Desplazamiento automático del punto (después del 1er dígito): Se activa cuando la longitud es >= 2
        if (soloNumeros.length >= 2) {
          // 17 -> 1.7
          // 175 -> 1.75
          v = soloNumeros.substring(0, 1) + "." + soloNumeros.substring(1);
        } else {
          // Mantener el valor sin punto (1)
          v = soloNumeros;
        }
      } else {
        // Hay punto manual, limitar a 2 decimales
        if (parts[1].length > 2) {
          parts[1] = parts[1].substring(0, 2);
          v = parts.join(".");
        }
      }

      // Validar máximo (2.50)
      const numValue = parseFloat(v);
      if (!isNaN(numValue) && numValue > 2.50) {
        // Si excede el máximo, no actualiza el valor
        return;
      }

      estaturaInput.value = v;
    }

    // --- Asignación de Eventos de Input ---
    pesoInput.addEventListener("input", handlePesoInput);
    estaturaInput.addEventListener("input", handleEstaturaInput);


    // --------------------------
    // LÓGICA DE BLUR (FORMATO FINAL Y VALIDACIÓN DE RANGO)
    // --------------------------
    function handleBlur(input, decimals, min, max) {
      input.addEventListener("blur", () => {
        let v = input.value.trim();
        const errorElement = document.querySelector(`.error-message[data-field="${input.id.split('_')[1]}"]`);

        // Limpieza final antes de parsear
        v = v.replace(/,/g, ".");

        const numValue = parseFloat(v);

        // Validación de rango
        if (isNaN(numValue) || numValue < min || numValue > max) {
          if (errorElement) {
            errorElement.textContent = `Valor debe estar entre ${min.toFixed(decimals)} y ${max.toFixed(decimals)}`;
          }
          return;
        }

        // Aplicar formato de decimales final (e.g., 1.7 -> 1.70, 12 -> 12.0)
        v = numValue.toFixed(decimals);
        input.value = v;
        if (errorElement) {
          errorElement.textContent = "";
        }
      });
    }

    // Aplica el formato y la validación final al salir
    handleBlur(pesoInput, 1, 1.0, 999.9);
    handleBlur(estaturaInput, 2, 0.50, 2.50);

    // --------------------------
    // VALIDACIÓN FINAL AL ENVIAR
    // --------------------------
    clinicalForm.addEventListener("submit", function (e) {
      // Forzar el evento blur para asegurar que el formato final se aplique antes de enviar
      pesoInput.focus();
      pesoInput.blur();
      estaturaInput.focus();
      estaturaInput.blur();

      // Revisar si hubo errores de validación en blur
      const errorPeso = document.querySelector(`.error-message[data-field="peso"]`).textContent;
      const errorEstatura = document.querySelector(`.error-message[data-field="estatura"]`).textContent;

      if (errorPeso || errorEstatura) {
        e.preventDefault();
        alert("Por favor, corrige los errores de formato y rango en Peso/Estatura.");
        return;
      }

      // Asegurar formato con punto para el backend
      pesoInput.value = pesoInput.value.replace(",", ".");
      estaturaInput.value = estaturaInput.value.replace(",", ".");
    });
  });
</script>

{% endblock %}